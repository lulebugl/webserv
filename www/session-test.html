<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test des Sessions - WebServ</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        color: #333;
        text-align: center;
        border-bottom: 3px solid #007bff;
        padding-bottom: 10px;
      }

      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .section h3 {
        margin-top: 0;
        color: #555;
      }

      .form-group {
        margin: 10px 0;
      }

      label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
      }

      input[type="text"],
      input[type="password"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }

      button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }

      button:hover {
        background-color: #0056b3;
      }

      button.danger {
        background-color: #dc3545;
      }

      button.danger:hover {
        background-color: #c82333;
      }

      button.secondary {
        background-color: #6c757d;
      }

      button.secondary:hover {
        background-color: #545b62;
      }

      .result {
        margin: 10px 0;
        padding: 15px;
        border-radius: 4px;
        min-height: 50px;
      }

      .success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .status {
        margin: 20px 0;
        padding: 15px;
        border-radius: 4px;
        background-color: #e2e3e5;
        border: 1px solid #d6d8db;
      }

      .user-info {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
      }

      .credentials-help {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 0.9em;
      }

      pre {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        border: 1px solid #e9ecef;
      }

      .session-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 10px 0;
      }

      .session-details div {
        padding: 8px;
        background-color: #f8f9fa;
        border-radius: 3px;
      }

      @media (max-width: 600px) {
        .session-details {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Test du Syst√®me de Sessions WebServ</h1>

      <div class="credentials-help">
        <strong>Utilisateurs de test disponibles :</strong><br />
        ‚Ä¢ admin / password123<br />
        ‚Ä¢ user / user123<br />
        ‚Ä¢ test / test
      </div>

      <!-- Section de connexion -->
      <div class="section">
        <h3>üìù Connexion</h3>
        <div class="form-group">
          <label for="username">Nom d'utilisateur :</label>
          <input
            type="text"
            id="username"
            placeholder="Entrez votre nom d'utilisateur"
          />
        </div>
        <div class="form-group">
          <label for="password">Mot de passe :</label>
          <input
            type="password"
            id="password"
            placeholder="Entrez votre mot de passe"
          />
        </div>
        <button onclick="login()">Se connecter</button>
        <div id="loginResult" class="result" style="display: none"></div>
      </div>

      <!-- Section des informations utilisateur -->
      <div class="section">
        <h3>üë§ Informations utilisateur</h3>
        <button onclick="getMe()" class="secondary">V√©rifier ma session</button>
        <div id="meResult" class="result" style="display: none"></div>
      </div>

      <!-- Section de d√©connexion -->
      <div class="section">
        <h3>üö™ D√©connexion</h3>
        <button onclick="logout()" class="danger">Se d√©connecter</button>
        <div id="logoutResult" class="result" style="display: none"></div>
      </div>

      <!-- Section de test automatique -->
      <div class="section">
        <h3>üß™ Tests automatiques</h3>
        <button onclick="runFullTest()" class="secondary">
          Lancer test complet
        </button>
        <div id="testResult" class="result" style="display: none"></div>
      </div>

      <!-- Status g√©n√©ral -->
      <div class="status">
        <h3>üìä Status du syst√®me</h3>
        <div id="systemStatus">Pr√™t pour les tests...</div>
      </div>
    </div>

    <script>
      // Fonction utilitaire pour afficher les r√©sultats
      function displayResult(elementId, data, isSuccess) {
        const element = document.getElementById(elementId);
        element.style.display = "block";
        element.className = `result ${isSuccess ? "success" : "error"}`;

        if (typeof data === "object") {
          element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        } else {
          element.innerHTML = data;
        }
      }

      // Fonction de connexion
      async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        if (!username || !password) {
          displayResult(
            "loginResult",
            "Veuillez remplir tous les champs",
            false
          );
          return;
        }

        try {
          const response = await fetch("/login.py", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();
          displayResult("loginResult", data, data.ok);

          if (data.ok) {
            updateSystemStatus(`‚úÖ Connect√© en tant que ${username}`);
            // Vider les champs de connexion
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
          } else {
            updateSystemStatus("‚ùå √âchec de la connexion");
          }
        } catch (error) {
          displayResult(
            "loginResult",
            `Erreur de connexion: ${error.message}`,
            false
          );
          updateSystemStatus("‚ùå Erreur de connexion");
        }
      }

      // Fonction pour r√©cup√©rer les infos utilisateur
      async function getMe() {
        try {
          const response = await fetch("/me.py", {
            method: "GET",
            credentials: "include",
          });

          const data = await response.json();

          if (data.ok) {
            // Affichage d√©taill√© des informations
            let html = `
                        <div class="user-info">
                            <h4>üë§ ${data.username}</h4>
                            <div class="session-details">
                                <div><strong>Session ID:</strong> ${data.session_info.session_id}</div>
                                <div><strong>IP:</strong> ${data.session_info.ip_address}</div>
                                <div><strong>Cr√©√©e le:</strong> ${data.session_info.created_at}</div>
                                <div><strong>Dernier acc√®s:</strong> ${data.session_info.last_access}</div>
                                <div><strong>Dur√©e session:</strong> ${data.session_info.session_duration}</div>
                                <div><strong>Sessions actives:</strong> ${data.session_info.total_sessions}</div>
                            </div>
                        </div>
                    `;
            document.getElementById("meResult").innerHTML = html;
            document.getElementById("meResult").className = "result success";
            updateSystemStatus(`‚úÖ Session active pour ${data.username}`);
          } else {
            displayResult("meResult", data, false);
            updateSystemStatus("‚ùå Aucune session active");
          }

          document.getElementById("meResult").style.display = "block";
        } catch (error) {
          displayResult("meResult", `Erreur: ${error.message}`, false);
          updateSystemStatus("‚ùå Erreur lors de la v√©rification");
        }
      }

      // Fonction de d√©connexion
      async function logout() {
        try {
          const response = await fetch("/logout.py", {
            method: "POST",
            credentials: "include",
          });

          const data = await response.json();
          displayResult("logoutResult", data, data.ok);

          if (data.ok) {
            updateSystemStatus("‚úÖ D√©connect√© avec succ√®s");
            // Nettoyer les autres r√©sultats
            document.getElementById("meResult").style.display = "none";
          } else {
            updateSystemStatus("‚ùå Erreur lors de la d√©connexion");
          }
        } catch (error) {
          displayResult("logoutResult", `Erreur: ${error.message}`, false);
          updateSystemStatus("‚ùå Erreur de d√©connexion");
        }
      }

      // Test complet automatique
      async function runFullTest() {
        const testElement = document.getElementById("testResult");
        testElement.style.display = "block";
        testElement.className = "result info";
        testElement.innerHTML = "üîÑ Lancement du test complet...";

        let log = [];

        try {
          // Test 1: V√©rifier l'√©tat initial (pas connect√©)
          log.push("1. Test initial - v√©rification de l'√©tat non connect√©...");
          let response = await fetch("/me.py");
          let data = await response.json();
          log.push(
            `   R√©sultat: ${data.ok ? "‚ùå FAIL" : "‚úÖ OK"} - ${
              data.error || "√âtat correct"
            }`
          );

          // Test 2: Connexion avec des identifiants valides
          log.push("2. Test de connexion avec admin/password123...");
          response = await fetch("/login.py", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: "admin",
              password: "password123",
            }),
          });
          data = await response.json();
          log.push(
            `   R√©sultat: ${data.ok ? "‚úÖ OK" : "‚ùå FAIL"} - ${
              data.message || data.error
            }`
          );

          // Test 3: V√©rifier la session apr√®s connexion
          if (data.ok) {
            log.push("3. V√©rification de la session apr√®s connexion...");
            response = await fetch("/me.py");
            data = await response.json();
            log.push(
              `   R√©sultat: ${
                data.ok ? "‚úÖ OK" : "‚ùå FAIL"
              } - Connect√© en tant que ${data.username || "erreur"}`
            );
          }

          // Test 4: D√©connexion
          log.push("4. Test de d√©connexion...");
          response = await fetch("/logout.py", { method: "POST" });
          data = await response.json();
          log.push(
            `   R√©sultat: ${data.ok ? "‚úÖ OK" : "‚ùå FAIL"} - ${
              data.message || data.error
            }`
          );

          // Test 5: V√©rifier l'√©tat apr√®s d√©connexion
          log.push("5. V√©rification de l'√©tat apr√®s d√©connexion...");
          response = await fetch("/me.py");
          data = await response.json();
          log.push(
            `   R√©sultat: ${data.ok ? "‚ùå FAIL" : "‚úÖ OK"} - ${
              data.error || "√âtat correct"
            }`
          );

          // Test 6: Tentative de connexion avec de mauvais identifiants
          log.push("6. Test avec des identifiants incorrects...");
          response = await fetch("/login.py", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: "wronguser",
              password: "wrongpass",
            }),
          });
          data = await response.json();
          log.push(
            `   R√©sultat: ${data.ok ? "‚ùå FAIL" : "‚úÖ OK"} - Rejet attendu: ${
              data.error
            }`
          );

          log.push("\nüéâ Test complet termin√©!");
          testElement.innerHTML = `<pre>${log.join("\n")}</pre>`;
          testElement.className = "result success";
          updateSystemStatus("‚úÖ Tests automatiques termin√©s");
        } catch (error) {
          log.push(`‚ùå ERREUR: ${error.message}`);
          testElement.innerHTML = `<pre>${log.join("\n")}</pre>`;
          testElement.className = "result error";
          updateSystemStatus("‚ùå Erreur durant les tests");
        }
      }

      // Mettre √† jour le status du syst√®me
      function updateSystemStatus(status) {
        document.getElementById(
          "systemStatus"
        ).innerHTML = `${status} - ${new Date().toLocaleTimeString()}`;
      }

      // Permettre la soumission avec Enter
      document
        .getElementById("password")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            login();
          }
        });

      // V√©rifier l'√©tat initial au chargement
      window.onload = function () {
        updateSystemStatus("üîß Syst√®me initialis√©");
        getMe(); // V√©rifier si d√©j√† connect√©
      };
    </script>
  </body>
</html>
